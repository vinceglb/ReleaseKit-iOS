name: Tag

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: Version component to bump (relative to the latest tag).
        type: choice
        required: true
        default: patch
        options:
          - patch
          - minor
          - major
      prerelease_suffix:
        description: Optional pre-release suffix appended after a dash (e.g. beta.1).
        type: string
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: tag-management
  cancel-in-progress: false

jobs:
  create-tag:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Require main branch
        if: github.ref_name != 'main'
        run: |
          echo "::error::Tags must be created from the main branch. Current branch: ${{ github.ref_name }}"
          exit 1

      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Compute custom tag for pre-release
        id: prerelease
        if: inputs.prerelease_suffix != ''
        shell: bash
        run: |
          set -euo pipefail
          LATEST=$(git describe --tags --match "v[0-9]*" --abbrev=0 2>/dev/null || echo "v0.0.0")
          VERSION="${LATEST#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "${VERSION}"
          PATCH="${PATCH%%-*}"
          case "${{ inputs.bump_type }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac
          echo "tag=${MAJOR}.${MINOR}.${PATCH}-${{ inputs.prerelease_suffix }}" >> "$GITHUB_OUTPUT"

      - name: Bump and push tag
        id: tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: ${{ inputs.bump_type }}
          custom_tag: ${{ steps.prerelease.outputs.tag }}
          create_annotated_tag: true
          tag_prefix: v

      - name: Update major floating tag
        shell: bash
        run: |
          set -euo pipefail
          NEW_TAG="${{ steps.tag.outputs.new_tag }}"
          MAJOR_TAG="${NEW_TAG%%.*}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -fa "${MAJOR_TAG}" -m "Release ${NEW_TAG} (${MAJOR_TAG})"
          git push origin "${MAJOR_TAG}" --force
          echo "Updated floating tag: ${MAJOR_TAG} → ${NEW_TAG}"

      - name: Write job summary
        shell: bash
        run: |
          NEW_TAG="${{ steps.tag.outputs.new_tag }}"
          MAJOR_TAG="${NEW_TAG%%.*}"
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          ## Tag created

          | | Value |
          |---|---|
          | **Semver tag** | \`${NEW_TAG}\` |
          | **Floating tag** | \`${MAJOR_TAG}\` → \`${NEW_TAG}\` |
          | **Commit** | \`${GITHUB_SHA}\` |
          EOF
